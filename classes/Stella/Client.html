<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang='en'>
  <head>
    <title>: Stella::Client [stella 2.1.1.001]</title>
    <meta content='text/html; charset=UTF-8' http-equiv='Content-Type'>
    <link href='../../rdoc-style.css' media='screen' rel='stylesheet' type='text/css'>
    <script type='text/javascript'>
      //<![CDATA[
        function popupCode(url) {
          window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
        }
        
        function toggleCode(id) {
          var code = document.getElementById(id)
        
          code.style.display = code.style.display != 'block' ? 'block' : 'none'
          return true
        }
        
        // Make codeblocks hidden by default
        document.writeln('<' + 'style type="text/css">.method .source pre { display: none }<\/style>')
      //]]>
    </script>
  </head>
  <body class='page'>
    <div class='class' id='wrapper'>
      <div class='header'>
        <h1 class='name'>
          <span class='type'>Class</span>
          Stella::Client
        </h1>
        <ol class='paths'>
          <li>
            <a href="../../files/lib/stella/client_rb.html">lib/stella/client.rb</a>
          </li>
        </ol>
        <div class='parent'>
          Parent:
          <strong>Object</strong>
        </div>
      </div>
      <div id='content'>
        <div id='text'>
          <div id='method-list'>
            <h2>Methods</h2>
            <h3>public class</h3>
            <ol>
              <li><a href="#M000076">new</a></li>
            </ol>
            <h3>public instance</h3>
            <ol>
              <li><a href="#M000081">create_http_client</a></li>
              <li><a href="#M000080">debug</a></li>
              <li><a href="#M000082">done!</a></li>
              <li><a href="#M000083">done?</a></li>
              <li><a href="#M000077">exception</a></li>
              <li><a href="#M000078">execute</a></li>
              <li><a href="#M000079">run_sleeper</a></li>
            </ol>
          </div>
          <div id='context'>
            <div id='includes'>
              <h2>Included modules</h2>
              <ol>
                <li>Gibbler::Complex</li>
                <li>HTTPClient::Timeout</li>
              </ol>
            </div>
          </div>
          <div id='section'>
            <div id='constants-list'>
              <h2>Constants</h2>
              <div class='name-list'>
                <table summary='Constants'>
                  <tr class='top-aligned-row context-row'>
                    <td class='context-item-name'>SSL_CERT_PATH</td>
                    <td>=</td>
                    <td class='context-item-value'>File.join(STELLA_LIB_HOME, '..', 'certs', 'stella-master.crt').freeze</td>
                  </tr>
                </table>
              </div>
            </div>
            <div id='attribute-list'>
              <h2 class='section-bar'>Attributes</h2>
              <div class='name-list'>
                <table>
                  <tr class='top-aligned-row context-row'>
                    <td class='context-item-name'>base_uri</td>
                    <td class='context-item-value'>[RW]</td>
                    <td class='context-item-desc'></td>
                  </tr>
                  <tr class='top-aligned-row context-row'>
                    <td class='context-item-name'>clientid</td>
                    <td class='context-item-value'>[R]</td>
                    <td class='context-item-desc'></td>
                  </tr>
                  <tr class='top-aligned-row context-row'>
                    <td class='context-item-name'>created</td>
                    <td class='context-item-value'>[RW]</td>
                    <td class='context-item-desc'></td>
                  </tr>
                  <tr class='top-aligned-row context-row'>
                    <td class='context-item-name'>index</td>
                    <td class='context-item-value'>[R]</td>
                    <td class='context-item-desc'></td>
                  </tr>
                  <tr class='top-aligned-row context-row'>
                    <td class='context-item-name'>proxy</td>
                    <td class='context-item-value'>[RW]</td>
                    <td class='context-item-desc'></td>
                  </tr>
                </table>
              </div>
            </div>
            <div id='methods'>
              <h2>Public class methods</h2>
              <div class='method public-class' id='method-M000076'>
                <a name='M000076'>      </a>
                <div class='synopsis'>
                  <span class='name'>new</span>
                  <span class='arguments'>(opts={})</span>
                </div>
                <div class='description'>
                  <p>
                  Options:
                  </p>
                  <ul>
                  <li>:timeout (Integer) => 30
                  
                  </li>
                  <li>:ssl_verify_mode (Class) => nil (possible values:
                  OpenSSL::SSL::VERIFY_NONE)
                  
                  </li>
                  </ul>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000076-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000076-source'><span class="ruby-comment cmt"># File lib/stella/client.rb, line 34</span>&#x000A;    <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">initialize</span>(<span class="ruby-identifier">opts</span>={})&#x000A;      <span class="ruby-ivar">@index</span> = <span class="ruby-ivar">@@client_index</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>&#x000A;      <span class="ruby-ivar">@created</span> = <span class="ruby-constant">Stella</span>.<span class="ruby-identifier">now</span>&#x000A;      <span class="ruby-ivar">@opts</span> = <span class="ruby-identifier">opts</span>&#x000A;      <span class="ruby-ivar">@opts</span>[<span class="ruby-identifier">:timeout</span>] <span class="ruby-operator">||=</span> <span class="ruby-value">30</span>&#x000A;      <span class="ruby-ivar">@base_uri</span>, <span class="ruby-ivar">@index</span> = <span class="ruby-identifier">opts</span>[<span class="ruby-identifier">:base_uri</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">opts</span>[<span class="ruby-value str">'base_uri'</span>], <span class="ruby-identifier">index</span>&#x000A;      <span class="ruby-ivar">@proxy</span> = <span class="ruby-constant">OpenStruct</span>.<span class="ruby-identifier">new</span>&#x000A;      <span class="ruby-ivar">@done</span> = <span class="ruby-keyword kw">false</span>&#x000A;      <span class="ruby-ivar">@session</span> = <span class="ruby-constant">Session</span>.<span class="ruby-identifier">new</span> <span class="ruby-ivar">@base_uri</span>&#x000A;      <span class="ruby-ivar">@redirect_count</span> = <span class="ruby-value">0</span>&#x000A;      <span class="ruby-ivar">@clientid</span> = [<span class="ruby-ivar">@session</span>.<span class="ruby-identifier">object_id</span>, <span class="ruby-identifier">created</span>, <span class="ruby-identifier">index</span>, <span class="ruby-identifier">opts</span>].<span class="ruby-identifier">digest</span>&#x000A;    <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <h2>Public instance methods</h2>
              <div class='method public-instance' id='method-M000081'>
                <a name='M000081'>      </a>
                <div class='synopsis'>
                  <span class='name'>create_http_client</span>
                  <span class='arguments'>()</span>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000081-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000081-source'><span class="ruby-comment cmt"># File lib/stella/client.rb, line 195</span>&#x000A;    <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">create_http_client</span>&#x000A;      <span class="ruby-identifier">http_client</span> = <span class="ruby-constant">HTTPClient</span>.<span class="ruby-identifier">new</span>(&#x000A;        <span class="ruby-identifier">:agent_name</span>  =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@opts</span>[<span class="ruby-identifier">:agent</span>] <span class="ruby-operator">||</span> <span class="ruby-ivar">@opts</span>[<span class="ruby-value str">'agent'</span>] <span class="ruby-operator">||</span> <span class="ruby-constant">Stella</span>.<span class="ruby-identifier">agent</span>,&#x000A;        <span class="ruby-identifier">:from</span>        =<span class="ruby-operator">&gt;</span> <span class="ruby-keyword kw">nil</span>&#x000A;      )&#x000A;      <span class="ruby-comment cmt">#http_client.set_proxy_auth(@proxy.user, @proxy.pass) if @proxy.user</span>&#x000A;      <span class="ruby-comment cmt">#http_client.debug_dev = STDOUT if Stella.debug?</span>&#x000A;      <span class="ruby-identifier">http_client</span>.<span class="ruby-identifier">protocol_version</span> = <span class="ruby-value str">&quot;HTTP/1.1&quot;</span>&#x000A;      <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@opts</span>[<span class="ruby-identifier">:ssl_verify_mode</span>]&#x000A;        <span class="ruby-identifier">http_client</span>.<span class="ruby-identifier">ssl_config</span>.<span class="ruby-identifier">verify_mode</span> = <span class="ruby-ivar">@opts</span>[<span class="ruby-identifier">:ssl_verify_mode</span>]&#x000A;      <span class="ruby-keyword kw">end</span>&#x000A;      &#x000A;      <span class="ruby-comment cmt"># See: http://ghouston.blogspot.com/2006/03/using-ssl-with-ruby-http-access2.html</span>&#x000A;      <span class="ruby-keyword kw">begin</span> &#x000A;        <span class="ruby-identifier">http_client</span>.<span class="ruby-identifier">ssl_config</span>.<span class="ruby-identifier">clear_cert_store</span>&#x000A;        <span class="ruby-identifier">http_client</span>.<span class="ruby-identifier">ssl_config</span>.<span class="ruby-identifier">set_trust_ca</span> <span class="ruby-constant">SSL_CERT_PATH</span>&#x000A;      <span class="ruby-keyword kw">rescue</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">ex</span>&#x000A;        <span class="ruby-constant">Stella</span>.<span class="ruby-identifier">li</span> <span class="ruby-identifier">ex</span>.<span class="ruby-identifier">class</span>, <span class="ruby-identifier">ex</span>.<span class="ruby-identifier">message</span>&#x000A;        <span class="ruby-constant">Stella</span>.<span class="ruby-identifier">ld</span> <span class="ruby-identifier">ex</span>.<span class="ruby-identifier">backtrace</span>&#x000A;      <span class="ruby-keyword kw">end</span>&#x000A;      &#x000A;      <span class="ruby-identifier">http_client</span>.<span class="ruby-identifier">connect_timeout</span> = <span class="ruby-ivar">@opts</span>[<span class="ruby-identifier">:timeout</span>]&#x000A;      <span class="ruby-identifier">http_client</span>.<span class="ruby-identifier">send_timeout</span> = <span class="ruby-ivar">@opts</span>[<span class="ruby-identifier">:timeout</span>]&#x000A;      <span class="ruby-identifier">http_client</span>.<span class="ruby-identifier">receive_timeout</span> = <span class="ruby-ivar">@opts</span>[<span class="ruby-identifier">:timeout</span>]&#x000A;      <span class="ruby-identifier">http_client</span>&#x000A;    <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='method public-instance' id='method-M000080'>
                <a name='M000080'>      </a>
                <div class='synopsis'>
                  <span class='name'>debug</span>
                  <span class='arguments'>(msg)</span>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000080-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000080-source'><span class="ruby-comment cmt"># File lib/stella/client.rb, line 191</span>&#x000A;    <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">debug</span>(<span class="ruby-identifier">msg</span>)&#x000A;      <span class="ruby-constant">Stella</span>.<span class="ruby-identifier">ld</span> <span class="ruby-node">&quot; #{clientid.short} #{msg}&quot;</span>&#x000A;    <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='method public-instance' id='method-M000082'>
                <a name='M000082'>      </a>
                <div class='synopsis'>
                  <span class='name'>done!</span>
                  <span class='arguments'>()</span>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000082-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000082-source'><span class="ruby-comment cmt"># File lib/stella/client.rb, line 222</span>&#x000A;    <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">done!</span>&#x000A;      <span class="ruby-ivar">@done</span> = <span class="ruby-keyword kw">true</span>&#x000A;    <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='method public-instance' id='method-M000083'>
                <a name='M000083'>      </a>
                <div class='synopsis'>
                  <span class='name'>done?</span>
                  <span class='arguments'>()</span>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000083-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000083-source'><span class="ruby-comment cmt"># File lib/stella/client.rb, line 226</span>&#x000A;    <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">done?</span>&#x000A;      <span class="ruby-ivar">@done</span> <span class="ruby-operator">==</span> <span class="ruby-keyword kw">true</span>&#x000A;    <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='method public-instance' id='method-M000077'>
                <a name='M000077'>      </a>
                <div class='synopsis'>
                  <span class='name'>exception</span>
                  <span class='arguments'>()</span>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000077-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000077-source'><span class="ruby-comment cmt"># File lib/stella/client.rb, line 47</span>&#x000A;    <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">exception</span> &#x000A;      <span class="ruby-ivar">@session</span>.<span class="ruby-identifier">exception</span>&#x000A;    <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='method public-instance' id='method-M000078'>
                <a name='M000078'>      </a>
                <div class='synopsis'>
                  <span class='name'>execute</span>
                  <span class='arguments'>(usecase, &amp;each_request)</span>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000078-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000078-source'><span class="ruby-comment cmt"># File lib/stella/client.rb, line 51</span>&#x000A;    <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">execute</span> <span class="ruby-identifier">usecase</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">each_request</span>&#x000A;      <span class="ruby-ivar">@session</span>.<span class="ruby-identifier">http_client</span> = <span class="ruby-identifier">create_http_client</span>&#x000A;      <span class="ruby-identifier">tt</span> = <span class="ruby-constant">Benelux</span>.<span class="ruby-identifier">current_track</span>.<span class="ruby-identifier">timeline</span>&#x000A;      <span class="ruby-identifier">usecase</span>.<span class="ruby-identifier">requests</span>.<span class="ruby-identifier">each_with_index</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">rt</span>,<span class="ruby-identifier">idx</span><span class="ruby-operator">|</span>&#x000A;        <span class="ruby-keyword kw">begin</span> &#x000A;          <span class="ruby-identifier">debug</span> <span class="ruby-node">&quot;request start (session: #{@session.object_id})&quot;</span>&#x000A;          <span class="ruby-ivar">@session</span>.<span class="ruby-identifier">prepare_request</span> <span class="ruby-identifier">usecase</span>, <span class="ruby-identifier">rt</span> &#x000A;          &#x000A;          <span class="ruby-identifier">debug</span> <span class="ruby-node">&quot;#{@session.http_method} #{@session.uri} (#{rt.id.short})&quot;</span>&#x000A;          <span class="ruby-identifier">debug</span> <span class="ruby-node">&quot; #{@session.params.inspect}&quot;</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@session</span>.<span class="ruby-identifier">params</span>.<span class="ruby-identifier">empty?</span>&#x000A;          <span class="ruby-identifier">debug</span> <span class="ruby-node">&quot; #{@session.headers.inspect}&quot;</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@session</span>.<span class="ruby-identifier">headers</span>.<span class="ruby-identifier">empty?</span>&#x000A;          &#x000A;          <span class="ruby-identifier">stella_id</span> = [<span class="ruby-identifier">clientid</span>, <span class="ruby-identifier">rt</span>.<span class="ruby-identifier">id</span>, <span class="ruby-ivar">@session</span>.<span class="ruby-identifier">uri</span>.<span class="ruby-identifier">to_s</span>, <span class="ruby-ivar">@session</span>.<span class="ruby-identifier">params</span>, <span class="ruby-ivar">@session</span>.<span class="ruby-identifier">headers</span>, <span class="ruby-identifier">idx</span>].<span class="ruby-identifier">digest</span>&#x000A;          &#x000A;          <span class="ruby-constant">Benelux</span>.<span class="ruby-identifier">current_track</span>.<span class="ruby-identifier">add_tags</span> <span class="ruby-identifier">:request</span>   =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">rt</span>.<span class="ruby-identifier">id</span>&#x000A;          <span class="ruby-constant">Benelux</span>.<span class="ruby-identifier">current_track</span>.<span class="ruby-identifier">add_tags</span> <span class="ruby-identifier">:stella_id</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">stella_id</span>&#x000A;          &#x000A;          <span class="ruby-comment cmt">## Useful for testing larger large request header</span>&#x000A;          <span class="ruby-comment cmt">## 50.times do |idx|</span>&#x000A;          <span class="ruby-comment cmt">##   headers[&quot;X-header-#{idx}&quot;] = (1000 &lt;&lt; 1000).to_s</span>&#x000A;          <span class="ruby-comment cmt">## end</span>&#x000A;          &#x000A;          <span class="ruby-comment cmt"># Mis-behaving HTTP servers will fail w/o an Accept header</span>&#x000A;          <span class="ruby-ivar">@session</span>.<span class="ruby-identifier">headers</span>[<span class="ruby-value str">&quot;Accept&quot;</span>] <span class="ruby-operator">||=</span> <span class="ruby-value str">'*/*'</span>&#x000A;          &#x000A;          <span class="ruby-comment cmt"># if hard_timeout is nil this will do nothing</span>&#x000A;          <span class="ruby-identifier">timeout</span>(<span class="ruby-ivar">@opts</span>[<span class="ruby-identifier">:hard_timeout</span>], <span class="ruby-constant">TimeoutError</span>) <span class="ruby-keyword kw">do</span>&#x000A;            <span class="ruby-ivar">@session</span>.<span class="ruby-identifier">generate_request</span> <span class="ruby-identifier">stella_id</span>&#x000A;          <span class="ruby-keyword kw">end</span>&#x000A;          <span class="ruby-identifier">res</span> = <span class="ruby-ivar">@session</span>.<span class="ruby-identifier">res</span>&#x000A;          &#x000A;          <span class="ruby-identifier">each_request</span>.<span class="ruby-identifier">call</span>(<span class="ruby-ivar">@session</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">each_request</span>.<span class="ruby-identifier">nil?</span>&#x000A;          &#x000A;          <span class="ruby-comment cmt"># Needs to happen before handle response incase it raises an exception</span>&#x000A;          <span class="ruby-identifier">log</span> = <span class="ruby-constant">Stella</span><span class="ruby-operator">::</span><span class="ruby-constant">Log</span><span class="ruby-operator">::</span><span class="ruby-constant">HTTP</span>.<span class="ruby-identifier">new</span> <span class="ruby-constant">Stella</span>.<span class="ruby-identifier">now</span>,  &#x000A;                   <span class="ruby-ivar">@session</span>.<span class="ruby-identifier">http_method</span>, <span class="ruby-ivar">@session</span>.<span class="ruby-identifier">uri</span>, <span class="ruby-ivar">@session</span>.<span class="ruby-identifier">params</span>, <span class="ruby-identifier">res</span>.<span class="ruby-identifier">request</span>.<span class="ruby-identifier">header</span>.<span class="ruby-identifier">dump</span>, &#x000A;                   <span class="ruby-identifier">res</span>.<span class="ruby-identifier">request</span>.<span class="ruby-identifier">body</span>.<span class="ruby-identifier">content</span>, <span class="ruby-identifier">res</span>.<span class="ruby-identifier">status</span>, <span class="ruby-identifier">res</span>.<span class="ruby-identifier">header</span>.<span class="ruby-identifier">dump</span>, <span class="ruby-identifier">res</span>.<span class="ruby-identifier">body</span>.<span class="ruby-identifier">content</span>&#x000A;          &#x000A;          <span class="ruby-identifier">tt</span>.<span class="ruby-identifier">add_count</span> <span class="ruby-identifier">:requests</span>, <span class="ruby-value">1</span>, <span class="ruby-identifier">:kind</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">:http</span>&#x000A;          &#x000A;          <span class="ruby-identifier">run_sleeper</span> <span class="ruby-ivar">@opts</span>[<span class="ruby-identifier">:wait</span>]&#x000A;          &#x000A;          <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@session</span>.<span class="ruby-identifier">response_handler?</span>&#x000A;            <span class="ruby-ivar">@session</span>.<span class="ruby-identifier">handle_response</span>&#x000A;          <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">res</span>.<span class="ruby-identifier">status</span> <span class="ruby-operator">&gt;=</span> <span class="ruby-value">400</span>&#x000A;            <span class="ruby-identifier">raise</span> <span class="ruby-constant">Stella</span><span class="ruby-operator">::</span><span class="ruby-constant">HTTPError</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">res</span>.<span class="ruby-identifier">status</span>)&#x000A;          <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">rt</span>.<span class="ruby-identifier">follow</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-ivar">@session</span>.<span class="ruby-identifier">redirect?</span>&#x000A;            <span class="ruby-identifier">raise</span> <span class="ruby-constant">ForcedRedirect</span>, <span class="ruby-ivar">@session</span>.<span class="ruby-identifier">location</span>&#x000A;          <span class="ruby-keyword kw">end</span>&#x000A;&#x000A;          <span class="ruby-identifier">tt</span>.<span class="ruby-identifier">add_message</span> <span class="ruby-identifier">log</span>, <span class="ruby-identifier">:status</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">res</span>.<span class="ruby-identifier">status</span>, <span class="ruby-identifier">:kind</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">:http_log</span>, <span class="ruby-identifier">:state</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">:nominal</span>&#x000A;          &#x000A;          <span class="ruby-ivar">@redirect_count</span> = <span class="ruby-value">0</span>&#x000A;          &#x000A;        <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">RepeatRequest</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">ex</span>&#x000A;          <span class="ruby-identifier">debug</span> <span class="ruby-node">&quot; REPEAT REQUEST: #{@session.location}&quot;</span>&#x000A;          <span class="ruby-keyword kw">retry</span>&#x000A;          &#x000A;        <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">ForcedRedirect</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">ex</span>  &#x000A;          <span class="ruby-comment cmt"># TODO: warn when redirecting from https to http</span>&#x000A;          <span class="ruby-identifier">debug</span> <span class="ruby-node">&quot; FOUND REDIRECT: #{@session.location}&quot;</span>&#x000A;          <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@redirect_count</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">10</span>&#x000A;            <span class="ruby-ivar">@redirect_count</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>&#x000A;            <span class="ruby-ivar">@session</span>.<span class="ruby-identifier">clear_previous_request</span>&#x000A;            <span class="ruby-ivar">@session</span>.<span class="ruby-identifier">redirect_uri</span> = <span class="ruby-identifier">ex</span>.<span class="ruby-identifier">location</span>&#x000A;            <span class="ruby-keyword kw">retry</span>&#x000A;          <span class="ruby-keyword kw">end</span>&#x000A;        &#x000A;        <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">ETIMEDOUT</span>, <span class="ruby-constant">SocketError</span>, &#x000A;               <span class="ruby-constant">HTTPClient</span><span class="ruby-operator">::</span><span class="ruby-constant">ConnectTimeoutError</span>, &#x000A;               <span class="ruby-constant">HTTPClient</span><span class="ruby-operator">::</span><span class="ruby-constant">SendTimeoutError</span>,&#x000A;               <span class="ruby-constant">HTTPClient</span><span class="ruby-operator">::</span><span class="ruby-constant">ReceiveTimeoutError</span>,&#x000A;               <span class="ruby-constant">TimeoutError</span>,&#x000A;               <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">ECONNRESET</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">ex</span>&#x000A;          <span class="ruby-identifier">debug</span> <span class="ruby-node">&quot;[#{ex.class}] #{ex.message}&quot;</span>&#x000A;          <span class="ruby-identifier">log</span> = <span class="ruby-constant">Stella</span><span class="ruby-operator">::</span><span class="ruby-constant">Log</span><span class="ruby-operator">::</span><span class="ruby-constant">HTTP</span>.<span class="ruby-identifier">new</span> <span class="ruby-constant">Stella</span>.<span class="ruby-identifier">now</span>, <span class="ruby-ivar">@session</span>.<span class="ruby-identifier">http_method</span>, <span class="ruby-ivar">@session</span>.<span class="ruby-identifier">uri</span>, <span class="ruby-ivar">@session</span>.<span class="ruby-identifier">params</span>&#x000A;          <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@session</span>.<span class="ruby-identifier">res</span> &#x000A;            <span class="ruby-identifier">log</span>.<span class="ruby-identifier">request_headers</span> = <span class="ruby-ivar">@session</span>.<span class="ruby-identifier">res</span>.<span class="ruby-identifier">request</span>.<span class="ruby-identifier">header</span>.<span class="ruby-identifier">dump</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@session</span>.<span class="ruby-identifier">res</span>.<span class="ruby-identifier">request</span> &#x000A;            <span class="ruby-identifier">log</span>.<span class="ruby-identifier">request_body</span> = <span class="ruby-ivar">@session</span>.<span class="ruby-identifier">res</span>.<span class="ruby-identifier">request</span>.<span class="ruby-identifier">body</span>.<span class="ruby-identifier">content</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@session</span>.<span class="ruby-identifier">res</span>.<span class="ruby-identifier">request</span> &#x000A;            <span class="ruby-identifier">log</span>.<span class="ruby-identifier">response_status</span> = <span class="ruby-ivar">@session</span>.<span class="ruby-identifier">res</span>.<span class="ruby-identifier">status</span>&#x000A;            <span class="ruby-identifier">log</span>.<span class="ruby-identifier">response_headers</span> = <span class="ruby-ivar">@session</span>.<span class="ruby-identifier">res</span>.<span class="ruby-identifier">header</span>.<span class="ruby-identifier">dump</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@session</span>.<span class="ruby-identifier">res</span>.<span class="ruby-identifier">content</span>&#x000A;            <span class="ruby-identifier">log</span>.<span class="ruby-identifier">response_body</span> = <span class="ruby-ivar">@session</span>.<span class="ruby-identifier">res</span>.<span class="ruby-identifier">body</span>.<span class="ruby-identifier">content</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@session</span>.<span class="ruby-identifier">res</span>.<span class="ruby-identifier">body</span>&#x000A;          <span class="ruby-keyword kw">end</span>&#x000A;          <span class="ruby-identifier">log</span>.<span class="ruby-identifier">msg</span> = <span class="ruby-node">&quot;#{ex.class} (#{@session.http_client.receive_timeout})&quot;</span>&#x000A;          <span class="ruby-identifier">tt</span>.<span class="ruby-identifier">add_message</span> <span class="ruby-identifier">log</span>, <span class="ruby-identifier">:kind</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">:http_log</span>, <span class="ruby-identifier">:state</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">:timeout</span>&#x000A;          <span class="ruby-constant">Benelux</span>.<span class="ruby-identifier">current_track</span>.<span class="ruby-identifier">remove_tags</span> <span class="ruby-identifier">:status</span>, <span class="ruby-identifier">:request</span>, <span class="ruby-identifier">:stella_id</span>&#x000A;          <span class="ruby-keyword kw">next</span>&#x000A;          &#x000A;        <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">StellaError</span>, <span class="ruby-constant">StellaBehavior</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">ex</span>&#x000A;          <span class="ruby-identifier">debug</span> <span class="ruby-node">&quot;[#{ex.class}] #{ex.message}&quot;</span>&#x000A;          <span class="ruby-identifier">log</span> = <span class="ruby-constant">Stella</span><span class="ruby-operator">::</span><span class="ruby-constant">Log</span><span class="ruby-operator">::</span><span class="ruby-constant">HTTP</span>.<span class="ruby-identifier">new</span> <span class="ruby-constant">Stella</span>.<span class="ruby-identifier">now</span>, <span class="ruby-ivar">@session</span>.<span class="ruby-identifier">http_method</span>, <span class="ruby-ivar">@session</span>.<span class="ruby-identifier">uri</span>, <span class="ruby-ivar">@session</span>.<span class="ruby-identifier">params</span>&#x000A;          <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@session</span>.<span class="ruby-identifier">res</span> &#x000A;            <span class="ruby-identifier">log</span>.<span class="ruby-identifier">request_headers</span> = <span class="ruby-ivar">@session</span>.<span class="ruby-identifier">res</span>.<span class="ruby-identifier">request</span>.<span class="ruby-identifier">header</span>.<span class="ruby-identifier">dump</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@session</span>.<span class="ruby-identifier">res</span>.<span class="ruby-identifier">request</span> &#x000A;            <span class="ruby-identifier">log</span>.<span class="ruby-identifier">request_body</span> = <span class="ruby-ivar">@session</span>.<span class="ruby-identifier">res</span>.<span class="ruby-identifier">request</span>.<span class="ruby-identifier">body</span>.<span class="ruby-identifier">content</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@session</span>.<span class="ruby-identifier">res</span>.<span class="ruby-identifier">request</span> &#x000A;            <span class="ruby-identifier">log</span>.<span class="ruby-identifier">response_status</span> = <span class="ruby-ivar">@session</span>.<span class="ruby-identifier">res</span>.<span class="ruby-identifier">status</span>&#x000A;            <span class="ruby-identifier">log</span>.<span class="ruby-identifier">response_headers</span> = <span class="ruby-ivar">@session</span>.<span class="ruby-identifier">res</span>.<span class="ruby-identifier">header</span>.<span class="ruby-identifier">dump</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@session</span>.<span class="ruby-identifier">res</span>.<span class="ruby-identifier">content</span>&#x000A;            <span class="ruby-identifier">log</span>.<span class="ruby-identifier">response_body</span> = <span class="ruby-ivar">@session</span>.<span class="ruby-identifier">res</span>.<span class="ruby-identifier">body</span>.<span class="ruby-identifier">content</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@session</span>.<span class="ruby-identifier">res</span>.<span class="ruby-identifier">body</span>&#x000A;          <span class="ruby-keyword kw">end</span>&#x000A;          <span class="ruby-identifier">log</span>.<span class="ruby-identifier">msg</span> = <span class="ruby-identifier">ex</span>.<span class="ruby-identifier">message</span>&#x000A;          <span class="ruby-identifier">tt</span>.<span class="ruby-identifier">add_message</span> <span class="ruby-identifier">log</span>, <span class="ruby-identifier">:status</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">log</span>.<span class="ruby-identifier">response_status</span>, <span class="ruby-identifier">:kind</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">:http_log</span>, <span class="ruby-identifier">:state</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">:exception</span>&#x000A;          <span class="ruby-constant">Benelux</span>.<span class="ruby-identifier">current_track</span>.<span class="ruby-identifier">remove_tags</span> <span class="ruby-identifier">:status</span>, <span class="ruby-identifier">:request</span>, <span class="ruby-identifier">:stella_id</span>&#x000A;          <span class="ruby-ivar">@session</span>.<span class="ruby-identifier">exception</span> = <span class="ruby-identifier">ex</span>&#x000A;          <span class="ruby-keyword kw">break</span>&#x000A;        &#x000A;        <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">ECONNREFUSED</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">ex</span>&#x000A;          <span class="ruby-identifier">debug</span> <span class="ruby-node">&quot;[#{ex.class}] #{ex.message}&quot;</span>&#x000A;          <span class="ruby-identifier">log</span> = <span class="ruby-constant">Stella</span><span class="ruby-operator">::</span><span class="ruby-constant">Log</span><span class="ruby-operator">::</span><span class="ruby-constant">HTTP</span>.<span class="ruby-identifier">new</span> <span class="ruby-constant">Stella</span>.<span class="ruby-identifier">now</span>, <span class="ruby-ivar">@session</span>.<span class="ruby-identifier">http_method</span>, <span class="ruby-ivar">@session</span>.<span class="ruby-identifier">uri</span>, <span class="ruby-ivar">@session</span>.<span class="ruby-identifier">params</span>&#x000A;          <span class="ruby-identifier">log</span>.<span class="ruby-identifier">msg</span> = <span class="ruby-value str">&quot;Connection refused&quot;</span>&#x000A;          <span class="ruby-identifier">tt</span>.<span class="ruby-identifier">add_message</span> <span class="ruby-identifier">log</span>, <span class="ruby-identifier">:status</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">log</span>.<span class="ruby-identifier">response_status</span>, <span class="ruby-identifier">:kind</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">:http_log</span>, <span class="ruby-identifier">:state</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">:exception</span>&#x000A;          <span class="ruby-constant">Benelux</span>.<span class="ruby-identifier">current_track</span>.<span class="ruby-identifier">remove_tags</span> <span class="ruby-identifier">:status</span>, <span class="ruby-identifier">:request</span>, <span class="ruby-identifier">:stella_id</span>&#x000A;          <span class="ruby-keyword kw">break</span>&#x000A;        &#x000A;        <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">OpenSSL</span><span class="ruby-operator">::</span><span class="ruby-constant">SSL</span><span class="ruby-operator">::</span><span class="ruby-constant">SSLError</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">ex</span>&#x000A;          <span class="ruby-identifier">debug</span> <span class="ruby-node">&quot;[#{ex.class}] #{ex.message}&quot;</span>&#x000A;          <span class="ruby-identifier">log</span> = <span class="ruby-constant">Stella</span><span class="ruby-operator">::</span><span class="ruby-constant">Log</span><span class="ruby-operator">::</span><span class="ruby-constant">HTTP</span>.<span class="ruby-identifier">new</span> <span class="ruby-constant">Stella</span>.<span class="ruby-identifier">now</span>, <span class="ruby-ivar">@session</span>.<span class="ruby-identifier">http_method</span>, <span class="ruby-ivar">@session</span>.<span class="ruby-identifier">uri</span>, <span class="ruby-ivar">@session</span>.<span class="ruby-identifier">params</span>&#x000A;          <span class="ruby-identifier">log</span>.<span class="ruby-identifier">msg</span> = <span class="ruby-identifier">ex</span>.<span class="ruby-identifier">message</span>&#x000A;          <span class="ruby-identifier">tt</span>.<span class="ruby-identifier">add_message</span> <span class="ruby-identifier">log</span>, <span class="ruby-identifier">:status</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">log</span>.<span class="ruby-identifier">response_status</span>, <span class="ruby-identifier">:kind</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">:http_log</span>, <span class="ruby-identifier">:state</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">:exception</span>&#x000A;          <span class="ruby-constant">Benelux</span>.<span class="ruby-identifier">current_track</span>.<span class="ruby-identifier">remove_tags</span> <span class="ruby-identifier">:status</span>, <span class="ruby-identifier">:request</span>, <span class="ruby-identifier">:stella_id</span>&#x000A;          <span class="ruby-keyword kw">break</span>&#x000A;          &#x000A;        <span class="ruby-keyword kw">rescue</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">ex</span>&#x000A;          <span class="ruby-constant">Stella</span>.<span class="ruby-identifier">le</span> <span class="ruby-node">&quot;[#{ex.class}] #{ex.message}&quot;</span>, <span class="ruby-identifier">ex</span>.<span class="ruby-identifier">backtrace</span>&#x000A;          <span class="ruby-identifier">log</span> = <span class="ruby-constant">Stella</span><span class="ruby-operator">::</span><span class="ruby-constant">Log</span><span class="ruby-operator">::</span><span class="ruby-constant">HTTP</span>.<span class="ruby-identifier">new</span> <span class="ruby-constant">Stella</span>.<span class="ruby-identifier">now</span>, <span class="ruby-ivar">@session</span>.<span class="ruby-identifier">http_method</span>, <span class="ruby-ivar">@session</span>.<span class="ruby-identifier">uri</span>, <span class="ruby-ivar">@session</span>.<span class="ruby-identifier">params</span>&#x000A;          <span class="ruby-identifier">log</span>.<span class="ruby-identifier">msg</span> = <span class="ruby-identifier">ex</span>.<span class="ruby-identifier">message</span>&#x000A;          <span class="ruby-identifier">tt</span>.<span class="ruby-identifier">add_message</span> <span class="ruby-identifier">log</span>, <span class="ruby-identifier">:status</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">log</span>.<span class="ruby-identifier">response_status</span>, <span class="ruby-identifier">:kind</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">:http_log</span>, <span class="ruby-identifier">:state</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">:fubar</span>&#x000A;          <span class="ruby-constant">Benelux</span>.<span class="ruby-identifier">current_track</span>.<span class="ruby-identifier">remove_tags</span> <span class="ruby-identifier">:status</span>, <span class="ruby-identifier">:request</span>, <span class="ruby-identifier">:stella_id</span>&#x000A;          <span class="ruby-keyword kw">break</span>&#x000A;          &#x000A;        <span class="ruby-keyword kw">end</span>&#x000A;      <span class="ruby-keyword kw">end</span>&#x000A;      &#x000A;    <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='method public-instance' id='method-M000079'>
                <a name='M000079'>      </a>
                <div class='synopsis'>
                  <span class='name'>run_sleeper</span>
                  <span class='arguments'>(dur)</span>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000079-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000079-source'><span class="ruby-comment cmt"># File lib/stella/client.rb, line 184</span>&#x000A;    <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">run_sleeper</span> <span class="ruby-identifier">dur</span>&#x000A;      <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">dur</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">dur</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>&#x000A;      <span class="ruby-identifier">dur</span> = (<span class="ruby-identifier">rand</span> <span class="ruby-operator">*</span> (<span class="ruby-identifier">dur</span>.<span class="ruby-identifier">last</span><span class="ruby-operator">-</span><span class="ruby-identifier">dur</span>.<span class="ruby-identifier">first</span>) <span class="ruby-operator">+</span> <span class="ruby-identifier">dur</span>.<span class="ruby-identifier">first</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-constant">Range</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">dur</span>&#x000A;      <span class="ruby-identifier">debug</span> <span class="ruby-node">&quot;sleep: #{dur}&quot;</span>&#x000A;      <span class="ruby-identifier">sleep</span> <span class="ruby-identifier">dur</span>&#x000A;    <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div id='footer-push'></div>
    </div>
    <div id='footer'>
      <a href="http://github.com/mislav/hanna/tree/master"><strong>Hanna</strong> RDoc template</a>
    </div>
  </body>
</html>
