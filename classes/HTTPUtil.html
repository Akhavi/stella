<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang='en'>
  <head>
    <title>: HTTPUtil [stella 0.8.6.002]</title>
    <meta content='text/html; charset=UTF-8' http-equiv='Content-Type'>
    <link href='../rdoc-style.css' media='screen' rel='stylesheet' type='text/css'>
    <script type='text/javascript'>
      //<![CDATA[
        function popupCode(url) {
          window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
        }
        
        function toggleCode(id) {
          var code = document.getElementById(id)
        
          code.style.display = code.style.display != 'block' ? 'block' : 'none'
          return true
        }
        
        // Make codeblocks hidden by default
        document.writeln('<' + 'style type="text/css">.method .source pre { display: none }<\/style>')
      //]]>
    </script>
  </head>
  <body class='page'>
    <div class='class' id='wrapper'>
      <div class='header'>
        <h1 class='name'>
          <span class='type'>Module</span>
          HTTPUtil
        </h1>
        <ol class='paths'>
          <li>
            <a href="../files/lib/stella/utils/httputil_rb.html">lib/stella/utils/httputil.rb</a>
          </li>
        </ol>
      </div>
      <div id='content'>
        <div id='text'>
          <div id='method-list'>
            <h2>Methods</h2>
            <h3>public class</h3>
            <ol>
              <li><a href="#M000318">escape</a></li>
              <li><a href="#M000317">hash_to_query</a></li>
              <li><a href="#M000315">parse_form_data</a></li>
              <li><a href="#M000308">parse_header</a></li>
              <li><a href="#M000311">parse_header_body</a></li>
              <li><a href="#M000309">parse_http_request</a></li>
              <li><a href="#M000310">parse_http_response</a></li>
              <li><a href="#M000312">parse_query</a></li>
              <li><a href="#M000314">parse_query_from_string</a></li>
              <li><a href="#M000316">query_to_hash</a></li>
              <li><a href="#M000319">unescape</a></li>
              <li><a href="#M000313">validate_method</a></li>
            </ol>
          </div>
          <div id='section'>
            <div id='constants-list'>
              <h2>Constants</h2>
              <div class='name-list'>
                <table summary='Constants'>
                  <tr class='top-aligned-row context-row'>
                    <td class='context-item-name'>VALID_METHODS</td>
                    <td>=</td>
                    <td class='context-item-value'>%w{GET HEAD POST PUT DELETE}</td>
                  </tr>
                </table>
              </div>
            </div>
            <div id='methods'>
              <h2>Public class methods</h2>
              <div class='method public-class' id='method-M000318'>
                <a name='M000318'>      </a>
                <div class='synopsis'>
                  <span class='name'>escape</span>
                  <span class='arguments'>(s)</span>
                </div>
                <div class='description'>
                  <p>
                  Performs URI escaping so that you can construct proper query strings
                  faster. Use this rather than the cgi.rb version since it&#8217;s faster.
                  (Stolen from Mongrel/Camping).
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000318-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000318-source'><span class="ruby-comment cmt"># File lib/stella/utils/httputil.rb, line 250</span>&#x000A;  <span class="ruby-keyword kw">def</span> <span class="ruby-constant">HTTPUtil</span>.<span class="ruby-identifier">escape</span>(<span class="ruby-identifier">s</span>)&#x000A;    <span class="ruby-identifier">s</span>.<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp re">/([^ a-zA-Z0-9_.-]+)/n</span>) {&#x000A;      <span class="ruby-value str">'%'</span><span class="ruby-operator">+</span><span class="ruby-identifier">$1</span>.<span class="ruby-identifier">unpack</span>(<span class="ruby-value str">'H2'</span><span class="ruby-operator">*</span><span class="ruby-identifier">$1</span>.<span class="ruby-identifier">size</span>).<span class="ruby-identifier">join</span>(<span class="ruby-value str">'%'</span>).<span class="ruby-identifier">upcase</span>&#x000A;    }.<span class="ruby-identifier">tr</span>(<span class="ruby-value str">' '</span>, <span class="ruby-value str">'+'</span>)&#x000A;  <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='method public-class' id='method-M000317'>
                <a name='M000317'>      </a>
                <div class='synopsis'>
                  <span class='name'>hash_to_query</span>
                  <span class='arguments'>(parameters)</span>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000317-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000317-source'><span class="ruby-comment cmt"># File lib/stella/utils/httputil.rb, line 235</span>&#x000A;  <span class="ruby-keyword kw">def</span> <span class="ruby-constant">HTTPUtil</span>.<span class="ruby-identifier">hash_to_query</span>(<span class="ruby-identifier">parameters</span>)&#x000A;    <span class="ruby-keyword kw">return</span> <span class="ruby-value str">''</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">parameters</span>&#x000A;    <span class="ruby-identifier">pairs</span> = []&#x000A;    <span class="ruby-identifier">parameters</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">param</span>, <span class="ruby-identifier">value</span><span class="ruby-operator">|</span>&#x000A;      <span class="ruby-identifier">pairs</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;#{param}=#{URI.escape(value.to_s)}&quot;</span>&#x000A;    <span class="ruby-keyword kw">end</span>&#x000A;    <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">pairs</span>.<span class="ruby-identifier">join</span>(<span class="ruby-value str">'&amp;'</span>)&#x000A;    <span class="ruby-comment cmt">#return pairs.join(&quot;;&quot;)</span>&#x000A;  <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='method public-class' id='method-M000315'>
                <a name='M000315'>      </a>
                <div class='synopsis'>
                  <span class='name'>parse_form_data</span>
                  <span class='arguments'>(io, boundary)</span>
                </div>
                <div class='description'>
                  <p>
                  Based on WEBrick::HTTPutils::parse_form_data
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000315-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000315-source'><span class="ruby-comment cmt"># File lib/stella/utils/httputil.rb, line 180</span>&#x000A;  <span class="ruby-keyword kw">def</span> <span class="ruby-constant">HTTPUtil</span>.<span class="ruby-identifier">parse_form_data</span>(<span class="ruby-identifier">io</span>, <span class="ruby-identifier">boundary</span>)&#x000A;    <span class="ruby-identifier">boundary_regexp</span> = <span class="ruby-node">/\A--#{boundary}(--)?#{$/}\z/</span>&#x000A;    <span class="ruby-identifier">form_data</span> = <span class="ruby-constant">Hash</span>.<span class="ruby-identifier">new</span>&#x000A;    <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">form_data</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">io</span>&#x000A;    <span class="ruby-identifier">data</span> = <span class="ruby-keyword kw">nil</span>&#x000A;    <span class="ruby-identifier">io</span>.<span class="ruby-identifier">each_line</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">line</span><span class="ruby-operator">|</span>&#x000A;      <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">boundary_regexp</span> <span class="ruby-operator">=~</span> <span class="ruby-identifier">line</span>&#x000A;        <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">data</span>&#x000A;          <span class="ruby-identifier">data</span>.<span class="ruby-identifier">chop!</span>&#x000A;          <span class="ruby-identifier">key</span> = <span class="ruby-identifier">data</span>.<span class="ruby-identifier">name</span>.<span class="ruby-identifier">tr</span>(<span class="ruby-value str">'-'</span>, <span class="ruby-value str">'_'</span>).<span class="ruby-identifier">to_sym</span>&#x000A;          <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">form_data</span>.<span class="ruby-identifier">has_key?</span>(<span class="ruby-identifier">key</span>)&#x000A;            <span class="ruby-identifier">form_data</span>[<span class="ruby-identifier">key</span>].<span class="ruby-identifier">append_data</span>(<span class="ruby-identifier">data</span>)&#x000A;          <span class="ruby-keyword kw">else</span>&#x000A;            <span class="ruby-identifier">form_data</span>[<span class="ruby-identifier">key</span>] = <span class="ruby-identifier">data</span> &#x000A;          <span class="ruby-keyword kw">end</span>&#x000A;        <span class="ruby-keyword kw">end</span>&#x000A;        <span class="ruby-identifier">data</span> = <span class="ruby-constant">FormData</span>.<span class="ruby-identifier">new</span>&#x000A;        <span class="ruby-keyword kw">next</span>&#x000A;      <span class="ruby-keyword kw">else</span>&#x000A;        <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">data</span>&#x000A;          <span class="ruby-identifier">data</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">line</span>&#x000A;        <span class="ruby-keyword kw">end</span>&#x000A;      <span class="ruby-keyword kw">end</span>&#x000A;    }&#x000A;    <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">form_data</span>&#x000A;  <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='method public-class' id='method-M000308'>
                <a name='M000308'>      </a>
                <div class='synopsis'>
                  <span class='name'>parse_header</span>
                  <span class='arguments'>(raw)</span>
                </div>
                <div class='description'>
                  <p>
                  Takes a string. See WEBrick::<a
                  href="HTTPUtil.html#M000308">parse_header</a>(string).
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000308-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000308-source'><span class="ruby-comment cmt"># File lib/stella/utils/httputil.rb, line 11</span>&#x000A;  <span class="ruby-keyword kw">def</span> <span class="ruby-constant">HTTPUtil</span>.<span class="ruby-identifier">parse_header</span>(<span class="ruby-identifier">raw</span>)&#x000A;    <span class="ruby-identifier">header</span> = <span class="ruby-constant">Hash</span>.<span class="ruby-identifier">new</span>([].<span class="ruby-identifier">freeze</span>)&#x000A;    <span class="ruby-identifier">raw</span>.<span class="ruby-identifier">each_line</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">line</span><span class="ruby-operator">|</span>&#x000A;      <span class="ruby-keyword kw">case</span> <span class="ruby-identifier">line</span>&#x000A;      <span class="ruby-keyword kw">when</span> <span class="ruby-regexp re">/\A(.+?):\s+(.+)\z/o</span><span class="ruby-identifier">m</span>&#x000A;        <span class="ruby-identifier">name</span>, <span class="ruby-identifier">value</span> = <span class="ruby-identifier">$1</span>, <span class="ruby-identifier">$2</span> &#x000A;        <span class="ruby-identifier">name</span> = <span class="ruby-identifier">name</span>.<span class="ruby-identifier">tr</span>(<span class="ruby-value str">'-'</span>, <span class="ruby-value str">'_'</span>).<span class="ruby-identifier">to_sym</span>&#x000A;        <span class="ruby-identifier">value</span>.<span class="ruby-identifier">strip!</span>&#x000A;        &#x000A;        <span class="ruby-identifier">header</span>[<span class="ruby-identifier">name</span>] = [] <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">header</span>.<span class="ruby-identifier">has_key?</span>(<span class="ruby-identifier">name</span>)&#x000A;        <span class="ruby-identifier">header</span>[<span class="ruby-identifier">name</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">value</span>&#x000A;      <span class="ruby-keyword kw">end</span>&#x000A;    <span class="ruby-keyword kw">end</span>&#x000A;    <span class="ruby-identifier">header</span>&#x000A;  <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='method public-class' id='method-M000311'>
                <a name='M000311'>      </a>
                <div class='synopsis'>
                  <span class='name'>parse_header_body</span>
                  <span class='arguments'>(data=[])</span>
                </div>
                <div class='description'>
                  <p>
                  Process everything after the first line of an HTTP request or response: GET
                  / HTTP/1.1 HTTP/1.1 200 OK etc... Used by <a
                  href="HTTPUtil.html#M000309">parse_http_request</a> and <a
                  href="HTTPUtil.html#M000310">parse_http_response</a> but can be used
                  separately. Takes a string or array of strings. A string should be
                  formatted like an HTTP request or response. If a body is present it should
                  be separated by two newlines. An array of string should contain an empty or
                  nil element between the header and body content. This will happen naturally
                  if the raw lines were split by a single line terminator. (i.e. /n/ rather
                  than /n\n/) Returns header (hash), body (string)
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000311-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000311-source'><span class="ruby-comment cmt"># File lib/stella/utils/httputil.rb, line 109</span>&#x000A;  <span class="ruby-keyword kw">def</span> <span class="ruby-constant">HTTPUtil</span>.<span class="ruby-identifier">parse_header_body</span>(<span class="ruby-identifier">data</span>=[])&#x000A;    <span class="ruby-identifier">header</span>, <span class="ruby-identifier">body</span> = {}, <span class="ruby-keyword kw">nil</span>&#x000A;    <span class="ruby-identifier">data</span> = <span class="ruby-identifier">data</span>.<span class="ruby-identifier">split</span>(<span class="ruby-regexp re">/\r?\n/</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">kind_of?</span> <span class="ruby-constant">Array</span>&#x000A;    <span class="ruby-identifier">data</span>.<span class="ruby-identifier">shift</span> <span class="ruby-keyword kw">while</span> (<span class="ruby-identifier">data</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">data</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">empty?</span>)   <span class="ruby-comment cmt"># Remove leading empties</span>&#x000A;    &#x000A;    <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">header</span>, <span class="ruby-identifier">body</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">data</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">data</span>.<span class="ruby-identifier">empty?</span>&#x000A;    &#x000A;    <span class="ruby-comment cmt">#puts data.to_yaml</span>&#x000A;    &#x000A;    <span class="ruby-comment cmt"># Skip that first line if it exists</span>&#x000A;    <span class="ruby-identifier">data</span>.<span class="ruby-identifier">shift</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">data</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">match</span>(<span class="ruby-regexp re">/\AHTTP|GET|POST|DELETE|PUT|HEAD/</span><span class="ruby-identifier">mo</span>)&#x000A;    &#x000A;    <span class="ruby-identifier">header_lines</span> = []&#x000A;    <span class="ruby-identifier">header_lines</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">shift</span> <span class="ruby-keyword kw">while</span> (<span class="ruby-operator">!</span><span class="ruby-identifier">data</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">nil?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">data</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">empty?</span>)&#x000A;    <span class="ruby-identifier">header</span> = <span class="ruby-constant">HTTPUtil</span><span class="ruby-operator">::</span><span class="ruby-identifier">parse_header</span>(<span class="ruby-identifier">header_lines</span>.<span class="ruby-identifier">join</span>(<span class="ruby-identifier">$/</span>))&#x000A;    &#x000A;    <span class="ruby-comment cmt"># We omit the blank line that delimits the header from the body</span>&#x000A;    <span class="ruby-identifier">body</span> = <span class="ruby-identifier">data</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>].<span class="ruby-identifier">join</span>(<span class="ruby-identifier">$/</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">empty?</span> &#x000A;    &#x000A;    <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">header</span>, <span class="ruby-identifier">body</span>&#x000A;  <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='method public-class' id='method-M000309'>
                <a name='M000309'>      </a>
                <div class='synopsis'>
                  <span class='name'>parse_http_request</span>
                  <span class='arguments'>(data, host=:unknown, port=80)</span>
                </div>
                <div class='description'>
                  <p>
                  Takes a string or array. See <a
                  href="HTTPUtil.html#M000311">parse_header_body</a> for further info.
                  Returns <tt>method</tt>, <tt>http_version</tt>, <tt>uri</tt>,
                  <tt>header</tt>, <tt>body</tt>
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000309-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000309-source'><span class="ruby-comment cmt"># File lib/stella/utils/httputil.rb, line 29</span>&#x000A;  <span class="ruby-keyword kw">def</span> <span class="ruby-constant">HTTPUtil</span>.<span class="ruby-identifier">parse_http_request</span>(<span class="ruby-identifier">data</span>, <span class="ruby-identifier">host</span>=<span class="ruby-identifier">:unknown</span>, <span class="ruby-identifier">port</span>=<span class="ruby-value">80</span>)&#x000A;    <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">data</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">data</span>.<span class="ruby-identifier">empty?</span>&#x000A;    <span class="ruby-identifier">data</span> = <span class="ruby-identifier">data</span>.<span class="ruby-identifier">split</span>(<span class="ruby-regexp re">/\r?\n/</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">kind_of?</span> <span class="ruby-constant">Array</span>&#x000A;    <span class="ruby-identifier">data</span>.<span class="ruby-identifier">shift</span> <span class="ruby-keyword kw">while</span> (<span class="ruby-identifier">data</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">empty?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">data</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">nil?</span>)   <span class="ruby-comment cmt"># Remove leading empties</span>&#x000A;    <span class="ruby-identifier">request_line</span> = <span class="ruby-identifier">data</span>.<span class="ruby-identifier">shift</span>                           <span class="ruby-comment cmt"># i.e. GET /path HTTP/1.1</span>&#x000A;    <span class="ruby-identifier">method</span>, <span class="ruby-identifier">path</span>, <span class="ruby-identifier">http_version</span> = <span class="ruby-keyword kw">nil</span>&#x000A;    &#x000A;    <span class="ruby-comment cmt"># With WEBrick and other proxies, the entire URI is included in HTTP requests. </span>&#x000A;    <span class="ruby-comment cmt"># i.e. GET http://stellaaahhhh.com/streetcar.png HTTP/1.1</span>&#x000A;    <span class="ruby-comment cmt"># The parser is expecting just the absolute path. </span>&#x000A;    <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">request_line</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp re">/^(\S+)\s+(http:\/\/.+)\s+(HTTP.+)?/</span><span class="ruby-identifier">mo</span>&#x000A;      <span class="ruby-identifier">uri</span> = <span class="ruby-constant">URI</span>.<span class="ruby-identifier">parse</span>(<span class="ruby-identifier">$2</span>)&#x000A;      <span class="ruby-identifier">request_line</span> = <span class="ruby-node">&quot;#{$1} #{uri.request_uri} #{$3}&quot;</span>&#x000A;      <span class="ruby-identifier">host</span> = <span class="ruby-identifier">uri</span>.<span class="ruby-identifier">host</span>&#x000A;    <span class="ruby-keyword kw">end</span>&#x000A;    &#x000A;    <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">request_line</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp re">/^(\S+)\s+(\S+)(?:\s+HTTP\/(\d+\.\d+))?/</span><span class="ruby-identifier">mo</span>&#x000A;      <span class="ruby-identifier">method</span> = <span class="ruby-identifier">$1</span>&#x000A;      <span class="ruby-identifier">http_version</span> = <span class="ruby-identifier">$3</span> <span class="ruby-comment cmt"># Comes before $2 b/c the split resets the numbered vars</span>&#x000A;      <span class="ruby-identifier">path</span>, <span class="ruby-identifier">query_string</span>   = <span class="ruby-identifier">$2</span>.<span class="ruby-identifier">split</span>(<span class="ruby-value str">'?'</span>)&#x000A;      &#x000A;      <span class="ruby-comment cmt"># We only process the header and body data when we know we're</span>&#x000A;      <span class="ruby-comment cmt"># starting from the beginning of a request string. We don't</span>&#x000A;      <span class="ruby-comment cmt"># want no partials. </span>&#x000A;      <span class="ruby-identifier">header</span>, <span class="ruby-identifier">body</span> = <span class="ruby-constant">HTTPUtil</span>.<span class="ruby-identifier">parse_header_body</span>(<span class="ruby-identifier">data</span>)&#x000A;      <span class="ruby-identifier">query</span> = <span class="ruby-constant">HTTPUtil</span>.<span class="ruby-identifier">parse_query</span>(<span class="ruby-identifier">method</span>, <span class="ruby-identifier">query_string</span>)&#x000A;      &#x000A;      &#x000A;      <span class="ruby-comment cmt"># TODO: Parse username/password</span>&#x000A;      <span class="ruby-identifier">uri</span> = <span class="ruby-constant">URI</span><span class="ruby-operator">::</span><span class="ruby-constant">HTTP</span>.<span class="ruby-identifier">build</span>({&#x000A;        <span class="ruby-identifier">:scheme</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value str">'http'</span>,&#x000A;        <span class="ruby-identifier">:host</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">header</span>[<span class="ruby-identifier">:Host</span>][<span class="ruby-value">0</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">host</span>.<span class="ruby-identifier">to_s</span>, &#x000A;        <span class="ruby-identifier">:port</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">port</span>, &#x000A;        <span class="ruby-identifier">:path</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">path</span>, &#x000A;        <span class="ruby-identifier">:query</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">query_string</span>&#x000A;      })&#x000A;      &#x000A;    <span class="ruby-keyword kw">else</span>&#x000A;      <span class="ruby-identifier">rl</span> = <span class="ruby-identifier">request_line</span>.<span class="ruby-identifier">sub</span>(<span class="ruby-regexp re">/\x0d?\x0a\z/o</span>, <span class="ruby-value str">''</span>)&#x000A;      <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;Bad Request-Line `#{rl}'.&quot;</span>&#x000A;    <span class="ruby-keyword kw">end</span>&#x000A;    &#x000A;    <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">method</span>, <span class="ruby-identifier">http_version</span>, <span class="ruby-identifier">uri</span>, <span class="ruby-identifier">header</span>, <span class="ruby-identifier">body</span>&#x000A;  <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='method public-class' id='method-M000310'>
                <a name='M000310'>      </a>
                <div class='synopsis'>
                  <span class='name'>parse_http_response</span>
                  <span class='arguments'>(data=[])</span>
                </div>
                <div class='description'>
                  <p>
                  Takes a string or array. See <a
                  href="HTTPUtil.html#M000311">parse_header_body</a> for further info.
                  Returns <tt>status</tt>, <tt>http_version</tt>, <tt>message</tt>,
                  <tt>header</tt>, <tt>body</tt>
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000310-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000310-source'><span class="ruby-comment cmt"># File lib/stella/utils/httputil.rb, line 77</span>&#x000A;  <span class="ruby-keyword kw">def</span> <span class="ruby-constant">HTTPUtil</span>.<span class="ruby-identifier">parse_http_response</span>(<span class="ruby-identifier">data</span>=[])&#x000A;    <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">data</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">data</span>.<span class="ruby-identifier">empty?</span>&#x000A;    <span class="ruby-identifier">data</span> = <span class="ruby-identifier">data</span>.<span class="ruby-identifier">split</span>(<span class="ruby-regexp re">/\r?\n/</span>) <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">data</span>.<span class="ruby-identifier">kind_of?</span> <span class="ruby-constant">Array</span>&#x000A;    <span class="ruby-identifier">data</span>.<span class="ruby-identifier">shift</span> <span class="ruby-keyword kw">while</span> (<span class="ruby-identifier">data</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">empty?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">data</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">nil?</span>)   <span class="ruby-comment cmt"># Remove leading empties</span>&#x000A;    <span class="ruby-identifier">status_line</span> = <span class="ruby-identifier">data</span>.<span class="ruby-identifier">shift</span>                            <span class="ruby-comment cmt"># ie. HTTP/1.1 200 OK</span>&#x000A;    <span class="ruby-identifier">http_version</span>, <span class="ruby-identifier">status</span>, <span class="ruby-identifier">message</span> = <span class="ruby-keyword kw">nil</span>&#x000A;    &#x000A;    <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">status_line</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp re">/^HTTP\/(\d.+?)(\s+(\d\d\d)\s+(.+))?$/</span><span class="ruby-identifier">mo</span>&#x000A;      <span class="ruby-identifier">http_version</span> = <span class="ruby-identifier">$1</span>&#x000A;      <span class="ruby-identifier">status</span>   = <span class="ruby-identifier">$2</span>&#x000A;      <span class="ruby-identifier">message</span>   = <span class="ruby-identifier">$4</span>&#x000A;      &#x000A;      <span class="ruby-identifier">header</span>, <span class="ruby-identifier">body</span>, <span class="ruby-identifier">query</span> = <span class="ruby-constant">HTTPUtil</span>.<span class="ruby-identifier">parse_header_body</span>(<span class="ruby-identifier">data</span>)&#x000A;      &#x000A;    <span class="ruby-keyword kw">else</span>  &#x000A;      <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;Bad Response-Line `#{status_line}'.&quot;</span>&#x000A;    <span class="ruby-keyword kw">end</span>&#x000A;    &#x000A;    <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">status</span>, <span class="ruby-identifier">http_version</span>, <span class="ruby-identifier">message</span>, <span class="ruby-identifier">header</span>, <span class="ruby-identifier">body</span>&#x000A;  <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='method public-class' id='method-M000312'>
                <a name='M000312'>      </a>
                <div class='synopsis'>
                  <span class='name'>parse_query</span>
                  <span class='arguments'>(request_method, query_string, content_type='', body='')</span>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000312-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000312-source'><span class="ruby-comment cmt"># File lib/stella/utils/httputil.rb, line 131</span>&#x000A;  <span class="ruby-keyword kw">def</span> <span class="ruby-constant">HTTPUtil</span>.<span class="ruby-identifier">parse_query</span>(<span class="ruby-identifier">request_method</span>, <span class="ruby-identifier">query_string</span>, <span class="ruby-identifier">content_type</span>=<span class="ruby-value str">''</span>, <span class="ruby-identifier">body</span>=<span class="ruby-value str">''</span>)&#x000A;    <span class="ruby-identifier">query</span> = <span class="ruby-constant">Hash</span>.<span class="ruby-identifier">new</span>([].<span class="ruby-identifier">freeze</span>)&#x000A;&#x000A;      <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">request_method</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;GET&quot;</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">request_method</span> <span class="ruby-operator">==</span> <span class="ruby-value str">&quot;HEAD&quot;</span>&#x000A;        <span class="ruby-identifier">query</span> = <span class="ruby-constant">HTTPUtil</span><span class="ruby-operator">::</span><span class="ruby-identifier">parse_query_from_string</span>(<span class="ruby-identifier">query_string</span>)&#x000A;      <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">content_type</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp re">/^application\/x-www-form-urlencoded/</span>&#x000A;        <span class="ruby-identifier">query</span> = <span class="ruby-constant">HTTPUtil</span><span class="ruby-operator">::</span><span class="ruby-identifier">parse_query_from_string</span>(<span class="ruby-identifier">body</span>)&#x000A;      <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">content_type</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp re">/^multipart\/form-data; boundary=(.+)/</span>&#x000A;        <span class="ruby-identifier">boundary</span> = <span class="ruby-identifier">$1</span>.<span class="ruby-identifier">tr</span>(<span class="ruby-value str">'&quot;'</span>, <span class="ruby-value str">''</span>)&#x000A;        <span class="ruby-identifier">query</span> = <span class="ruby-constant">HTTPUtil</span><span class="ruby-operator">::</span><span class="ruby-identifier">parse_form_data</span>(<span class="ruby-identifier">body</span>, <span class="ruby-identifier">boundary</span>)&#x000A;      <span class="ruby-keyword kw">else</span>&#x000A;        <span class="ruby-identifier">query</span>&#x000A;      <span class="ruby-keyword kw">end</span>&#x000A;&#x000A;    <span class="ruby-identifier">query</span>&#x000A;  <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='method public-class' id='method-M000314'>
                <a name='M000314'>      </a>
                <div class='synopsis'>
                  <span class='name'>parse_query_from_string</span>
                  <span class='arguments'>(qs, d = '&amp;;')</span>
                </div>
                <div class='description'>
                  <p>
                  Parses a query string by breaking it up at the &#8217;&amp;&#8217; and
                  &#8217;;&#8217; characters. You can also use this to parse cookies by
                  changing the characters used in the second parameter (which defaults to
                  &#8217;&amp;;&#8217;. Stolen from Mongrel
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000314-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000314-source'><span class="ruby-comment cmt"># File lib/stella/utils/httputil.rb, line 157</span>&#x000A;  <span class="ruby-keyword kw">def</span> <span class="ruby-constant">HTTPUtil</span>.<span class="ruby-identifier">parse_query_from_string</span>(<span class="ruby-identifier">qs</span>, <span class="ruby-identifier">d</span> = <span class="ruby-value str">'&amp;;'</span>)&#x000A;    <span class="ruby-identifier">params</span> = {}&#x000A;    (<span class="ruby-identifier">qs</span><span class="ruby-operator">||</span><span class="ruby-value str">''</span>).<span class="ruby-identifier">split</span>(<span class="ruby-node">/[#{d}] */n</span>).<span class="ruby-identifier">inject</span>(<span class="ruby-identifier">params</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">h</span>,<span class="ruby-identifier">p</span><span class="ruby-operator">|</span>&#x000A;      <span class="ruby-identifier">k</span>, <span class="ruby-identifier">v</span>=<span class="ruby-identifier">unescape</span>(<span class="ruby-identifier">p</span>).<span class="ruby-identifier">split</span>(<span class="ruby-value str">'='</span>,<span class="ruby-value">2</span>)&#x000A;      <span class="ruby-keyword kw">next</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">k</span>&#x000A;      <span class="ruby-identifier">k</span> = <span class="ruby-identifier">k</span>.<span class="ruby-identifier">tr</span>(<span class="ruby-value str">'-'</span>, <span class="ruby-value str">'_'</span>).<span class="ruby-identifier">to_sym</span>&#x000A;      <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">cur</span> = <span class="ruby-identifier">params</span>[<span class="ruby-identifier">k</span>]&#x000A;        <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">cur</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">==</span> <span class="ruby-constant">Array</span>&#x000A;          <span class="ruby-identifier">params</span>[<span class="ruby-identifier">k</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">v</span>&#x000A;        <span class="ruby-keyword kw">else</span>&#x000A;          <span class="ruby-identifier">params</span>[<span class="ruby-identifier">k</span>] = [<span class="ruby-identifier">cur</span>, <span class="ruby-identifier">v</span>]&#x000A;        <span class="ruby-keyword kw">end</span>&#x000A;      <span class="ruby-keyword kw">else</span>&#x000A;        <span class="ruby-identifier">params</span>[<span class="ruby-identifier">k</span>] = <span class="ruby-identifier">v</span>&#x000A;      <span class="ruby-keyword kw">end</span>&#x000A;    }&#x000A;&#x000A;    <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">params</span>&#x000A;  <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='method public-class' id='method-M000316'>
                <a name='M000316'>      </a>
                <div class='synopsis'>
                  <span class='name'>query_to_hash</span>
                  <span class='arguments'>(query_string)</span>
                </div>
                <div class='description'>
                  <p>
                  Extend the basic query string parser provided by the cgi module. converts
                  single valued params (the most common case) to objects instead of arrays
                  </p>
                  <p>
                  Input: the query string
                  </p>
                  <p>
                  Output: hash of parameters, contains arrays for multivalued parameters
                  (multiselect, checkboxes , etc) If no query string is provided (nil or
                  &#8220;&#8221;) returns an empty hash.
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000316-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000316-source'><span class="ruby-comment cmt"># File lib/stella/utils/httputil.rb, line 219</span>&#x000A;  <span class="ruby-keyword kw">def</span> <span class="ruby-constant">HTTPUtil</span>.<span class="ruby-identifier">query_to_hash</span>(<span class="ruby-identifier">query_string</span>)&#x000A;    <span class="ruby-keyword kw">return</span> {} <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">query_string</span>&#x000A;&#x000A;    <span class="ruby-identifier">query_parameters</span> = <span class="ruby-constant">HTTPUtil</span>.<span class="ruby-identifier">parse_query</span>(<span class="ruby-identifier">query_string</span>)&#x000A;&#x000A;    <span class="ruby-identifier">query_parameters</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">key</span>, <span class="ruby-identifier">val</span><span class="ruby-operator">|</span>&#x000A;      <span class="ruby-comment cmt"># replace the array with an object</span>&#x000A;      <span class="ruby-identifier">query_parameters</span>[<span class="ruby-identifier">key</span>] = <span class="ruby-identifier">val</span>[<span class="ruby-value">0</span>] <span class="ruby-keyword kw">if</span> <span class="ruby-value">1</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">val</span>.<span class="ruby-identifier">length</span>&#x000A;    }&#x000A;&#x000A;    <span class="ruby-comment cmt"># set default value to nil! cgi sets this to []</span>&#x000A;    <span class="ruby-identifier">query_parameters</span>.<span class="ruby-identifier">default</span> = <span class="ruby-keyword kw">nil</span>&#x000A;&#x000A;    <span class="ruby-keyword kw">return</span> <span class="ruby-identifier">query_parameters</span>&#x000A;  <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='method public-class' id='method-M000319'>
                <a name='M000319'>      </a>
                <div class='synopsis'>
                  <span class='name'>unescape</span>
                  <span class='arguments'>(s)</span>
                </div>
                <div class='description'>
                  <p>
                  Unescapes a URI escaped string. (Stolen from Mongrel/Camping).
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000319-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000319-source'><span class="ruby-comment cmt"># File lib/stella/utils/httputil.rb, line 258</span>&#x000A;  <span class="ruby-keyword kw">def</span> <span class="ruby-constant">HTTPUtil</span>.<span class="ruby-identifier">unescape</span>(<span class="ruby-identifier">s</span>)&#x000A;    <span class="ruby-identifier">s</span>.<span class="ruby-identifier">tr</span>(<span class="ruby-value str">'+'</span>, <span class="ruby-value str">' '</span>).<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp re">/((?:%[0-9a-fA-F]{2})+)/n</span>){&#x000A;      [<span class="ruby-identifier">$1</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-value str">'%'</span>)].<span class="ruby-identifier">pack</span>(<span class="ruby-value str">'H*'</span>)&#x000A;    }&#x000A;  <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='method public-class' id='method-M000313'>
                <a name='M000313'>      </a>
                <div class='synopsis'>
                  <span class='name'>validate_method</span>
                  <span class='arguments'>(meth='GET')</span>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000313-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000313-source'><span class="ruby-comment cmt"># File lib/stella/utils/httputil.rb, line 148</span>&#x000A;  <span class="ruby-keyword kw">def</span> <span class="ruby-constant">HTTPUtil</span>.<span class="ruby-identifier">validate_method</span>(<span class="ruby-identifier">meth</span>=<span class="ruby-value str">'GET'</span>)&#x000A;    (<span class="ruby-constant">VALID_METHODS</span>.<span class="ruby-identifier">member?</span> <span class="ruby-identifier">meth</span>.<span class="ruby-identifier">upcase</span>) <span class="ruby-operator">?</span> <span class="ruby-identifier">meth</span> <span class="ruby-operator">:</span> <span class="ruby-constant">VALID_METHODS</span>[<span class="ruby-value">0</span>]&#x000A;  <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div id='footer-push'></div>
    </div>
    <div id='footer'>
      <a href="http://github.com/mislav/hanna/tree/master"><strong>Hanna</strong> RDoc template</a>
    </div>
  </body>
</html>
